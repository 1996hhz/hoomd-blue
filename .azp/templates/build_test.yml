steps:
- checkout: self
  submodules: true
- script: set
- task: CMake@1
  inputs:
    cmakeArgs: $(Build.SourcesDirectory) -DBUILDNAME=${AGENT_JOBNAME} -DENABLE_CUDA=$(enable_cuda) -DENABLE_MPI=$(enable_mpi) -DENABLE_TBB=$(enable_tbb) -DBUILD_VALIDATION=$(build_validation) -DBUILD_TESTING=$(build_testing) -DBUILD_JIT=$(build_jit) -DLLVM_DIR=/usr/lib/llvm-$(llvm_version)/cmake -DBUILD_DEPRECATED=off -GNinja
    workingDirectory: $(Build.BinariesDirectory)
- script: nice -n 19 ninja -j 4
  displayName: Compile
  workingDirectory: $(Build.BinariesDirectory)
- script: |
            export PATH=/usr/lib/llvm-$(llvm_version)/bin:$PATH
            ctest --no-compress-output -T test --output-on-failure --test-output-size-failed 1048576 --test-output-size-passed 1048576
            cp $(Build.BinariesDirectory)/Testing/**/Test.xml $(Common.TestResultsDirectory)
  displayName: Unit test
  workingDirectory: $(Build.BinariesDirectory)
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'cTest'
    testResultsFiles: '$(Common.TestResultsDirectory)/*.xml'
